<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Collisions in Seattle 2025</title>

    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #menu {
            background:rgba(0,0,0,0.3);
            position: absolute;
            z-index: 1;
            top: 10px;
            right: 10px;
            border-radius: 100px;
            width: 140px;
            font-family: 'Open Sans', sans-serif;
        }

        #menu a {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.4);
            display: block;
            padding: 10px;
            text-decoration: none;
            text-align: center;
        }
        #menu a:last-child {
             border: none; 
        }

        #menu a:hover {
             color: rgb(255, 111, 0);
        }

        #menu a.active {
            color:rgb(255, 111, 0);
     
        }
        #menu a.active:hover { 
            color: rgba(255, 255, 255, 0.4);
        }

        /* Legend style */
        #legend {
            position: absolute;
            bottom: 40px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            font-family: 'Open Sans', sans-serif;
            z-index: 2;
        }

        .legend-entry {
            margin-bottom: 5px;
            color: rgb(204, 170, 0);
        }
        #chart {
            position: fixed;
            top: 300px;
            left: 10px;
            width: 460px;
            height: 350px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            z-index: 10; /* must be higher than map and other divs */
        
        }

        .c3 text {
            fill: rgb(255, 211, 33); 
            bottom:10px; 
    
        }
        #point-count {
            position:absolute; 
            top:10px; 
            left:250px;
            font-size:28px; 
            font-weight:bold; 
            color:orange;
            background: rgba(0,0,0,0.3); 
            padding:5px 10px;
            border-radius:5px;
            font-family: 'Open Sans', sans-serif;
        }
        #point-count-title {
            position:absolute;
            top:10px; 
            font-size:28px; 
            font-weight:bold; 
            color:rgb(255, 208, 0);
            background: rgba(0,0,0,0.3); 
            padding:5px 10px;
            border-radius:5px;
            font-family: 'Open Sans', sans-serif;
            left:10px
        }
        #text {
            position:absolute; 
            top:60px; 
            font-size:14px; 
            color:rgb(167, 161, 132);
            background: rgba(0,0,0,0.3); 
            padding:10px 10px;
            border-radius:5px;
            font-family: 'Open Sans', sans-serif;
            left:10px
        }
    
    </style>
</head>

<body>
    <div id="map"></div>
    <nav id="menu"></nav>
    <div id="legend"></div>
    <div id="point-count-title">Collision count:</div>
    <div id="point-count">0:</div>
    <div id="chart" ></div>
    <div class= box></div>
    <div id="text">  
        For this project, I used two datasets: 
        <a href ="https://data-seattlecitygis.opendata.arcgis.com/datasets/b4a142f592e94d39a3bf787f3c112c1d_0/explore?location=47.614610%2C-122.336918%2C11" target="_blank" style="color: rgb(255, 0, 0);"><strong>Neighborhood Atlas Map</strong> </a> 
         <br>and <a href="https://home.urbanlogiq.us/public/sdot-crash-analysis?c=47.9133696%2C-122.241024&z=11" target="_blank" style="color: rgb(255, 0, 0);"><strong>Crash Analysis</strong> </a>
      
        Using Google Colab, I cleaned both datasets, formatted <br>
        coordinates, and then combined them through a spatial join.
        This linked each <br>collision to its neighborhood, enabling analysis of collision patterns across <Br> Seattle.</div>


    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibnVnYWl5ZW4iLCJhIjoiY21rb29tNzZxMDMzYTNmcHBpYmlkZGJqNSJ9.aa6QqHmav1QDW8cZUNCBhw';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [-122.39, 47.61],
            zoom: 10.3
        });
        let pointsData;

        // Fetch points data
        fetch('assets/points2025.geojson')
            .then(res => res.json())
            .then(data => pointsData = data);



        map.on('load', () => {
            // Polygon source & layer
            map.addSource('2025polygon-data', {
                type: 'geojson',
                data: 'assets/polygonCount2025.geojson'
            });

            //lengend
            const grades = [6, 38, 68, 94, 191];
            const colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#db3e00'];

            const legend = document.getElementById('legend');
            legend.innerHTML = '<strong style="color:rgb(204, 170, 0);">Counts</strong><br><br>';

            for (let i = 0; i < grades.length; i++) {
                const item = document.createElement('div');
                item.className = 'legend-entry';

                //<6"
                const label =  `< ${grades[i]}`;

                // colored circle
                const dot = `<span style="display:inline-block; width:15px; height:15px; border-radius:50%; background:${colors[i]}; margin-right:5px;"></span>`;

                item.innerHTML = `${dot} ${label}`;
                legend.appendChild(item);
            }

            // neighborhood
            map.addLayer({
                id: 'polygon-counts',
                type: 'fill',
                source: '2025polygon-data',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'count'],
                        grades[0], colors[0],
                        grades[1], colors[1],
                        grades[2], colors[2],
                        grades[3], colors[3],
                        grades[4], colors[4]
                    ],
                    'fill-outline-color': '#46454F',
                    'fill-opacity': 0.7
                }
            });

            // Points source & layer
            map.addSource('points-data', {
                type: 'geojson',
                data: 'assets/points2025.geojson'
            });

            map.addLayer({
                id: 'points',
                type: 'circle',
                
                source: 'points-data',
                paint: {
                    'circle-color': '#E31A1C',
                    'circle-stroke-width': 1,
                    'circle-opacity': 0.7,
                    'circle-radius': 5
                }
            });

 

            // Polygon popup
            map.on('click', 'polygon-counts', (event) => {
                new mapboxgl.Popup()
                    .setLngLat(event.lngLat)
                    .setHTML(`<strong>Neighborhood:</strong> ${event.features[0].properties.S_HOOD}<br>
                              <strong>Counts:</strong> ${event.features[0].properties.count}`)
                    .addTo(map);
            });

                

            // Toggle points in menu
            map.on('idle', () => {
                if (!map.getLayer('points')) return;

                const toggleableLayerIds = ['polygon-counts', 'points'];
                const menu = document.getElementById('menu');

                toggleableLayerIds.forEach(id => {
                    // Skip if menu item already exists
                    if (document.getElementById(id)) return;

                    const link = document.createElement('a');
                    link.id = id;
                    link.href = '#';
                    link.textContent = id;

                    // Make layer visible and link active initially
                    map.setLayoutProperty(id, 'visibility', 'visible');
                    link.className = 'active';

                    link.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const visibility = map.getLayoutProperty(id, 'visibility');

                        if (visibility === 'visible') {
                            map.setLayoutProperty(id, 'visibility', 'none');
                            this.className = 'inactive';
                        } else {
                            map.setLayoutProperty(id, 'visibility', 'visible');
                            this.className = 'active';
                        }
                    };

                    menu.appendChild(link);
                });


            }); // on idle
            // Count visible points

            // pointsData is your GeoJSON loaded from fetch
            function calPoints(features, bounds) {
                let total = -1;
                features.features.forEach(d => {
                    if (bounds.contains(d.geometry.coordinates)) total += 1;
                });
                return total;
            }

            function updateCount() {
                if (!pointsData) return;
                const total = calPoints(pointsData, map.getBounds());
                document.getElementById('point-count').innerHTML = total;
            }

            // update count on map idle and initially
            map.on('idle', updateCount);
            updateCount();


           
            const weatherChart = c3.generate({
                size: { height: 350, width: 460 },
                data: {
                    x: 'Weather',
                    columns: [
                        ['Weather'], // will fill later
                        ['Count']    // will fill later
                    ],
                    type: 'bar',
                    colors: { Count: '#E31A1C' }
                },
                axis: {
                    x: { type: 'category', label: 'Weather' },
                    y: { label: 'Count' }
                },
                legend: { show: false },
                bindto: '#chart'
            });

            // count visible points by weather
            function updateWeatherChart() {
                if (!pointsData) return;

                const bounds = map.getBounds();
                const counts = {}; 

                pointsData.features.forEach(f => {
                    const coords = f.geometry.coordinates;
                    if (bounds.contains(coords)) {
                        const weather = f.properties.WEATHER || 'Null';
                        counts[weather] = (counts[weather] || 0) + 1;
                    }
                });

                const x = Object.keys(counts);
                const y = Object.values(counts);

                weatherChart.load({
                    columns: [
                        ['Weather', ...x],
                        ['Count', ...y]
                    ]
                });
            }

            map.on('idle', updateWeatherChart);
            updateWeatherChart(); 

    

          

               
        }); //  map.on('load')
    </script>
</body>
</html>
